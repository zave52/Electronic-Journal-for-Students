<div class="gradebook-container p-6" style="overflow: visible !important; height: auto;">
  <h2 class="text-2xl font-bold mb-6">Gradebook</h2>

  @if (loading) {
    <app-loader [mode]="'inline'" [message]="'Loading gradebook...'"></app-loader>
  }

  <div *ngIf="error" class="error-state text-red-600 text-center py-8">
    <p>{{ error }}</p>
  </div>

  <div *ngIf="!loading && !error" class="gradebook-content">
    <div class="mb-4 flex items-center justify-between">
      <div>
        <button
          (click)="saveAllChanges()"
          [disabled]="isSavingAll || (!hasChanges() && !hasInvalidGrades())"
          class="px-6 py-2 rounded font-medium transition-colors"
          [class.bg-blue-600]="hasChanges() && !hasInvalidGrades()"
          [class.text-white]="hasChanges() && !hasInvalidGrades()"
          [class.hover:bg-blue-700]="hasChanges() && !hasInvalidGrades() && !isSavingAll"
          [class.bg-gray-300]="!hasChanges() || hasInvalidGrades() || isSavingAll"
          [class.text-gray-500]="!hasChanges() || hasInvalidGrades() || isSavingAll"
          [class.cursor-not-allowed]="!hasChanges() || hasInvalidGrades() || isSavingAll">
          <span *ngIf="!isSavingAll">ðŸ’¾ Save Changes</span>
          <span *ngIf="isSavingAll">Saving...</span>
          <span *ngIf="hasChanges() && !hasInvalidGrades()" class="ml-2 text-sm">({{ changedCells.size }})</span>
        </button>
        <span *ngIf="hasChanges() && !hasInvalidGrades()" class="ml-3 text-sm text-gray-600">
          {{ changedCells.size }} unsaved change(s)
        </span>
        <span *ngIf="hasInvalidGrades()" class="ml-3 text-sm text-red-600">
          âš  {{ invalidCells.size }} invalid grade(s) - fix errors before saving
        </span>
      </div>
      <div *ngIf="saveMessage"
           class="px-4 py-2 rounded"
           [class.bg-green-100]="saveMessage.includes('âœ“')"
           [class.text-green-800]="saveMessage.includes('âœ“')"
           [class.bg-red-100]="saveMessage.includes('âœ—') || saveMessage.includes('Cannot')"
           [class.text-red-800]="saveMessage.includes('âœ—') || saveMessage.includes('Cannot')"
           [class.bg-gray-100]="!saveMessage.includes('âœ“') && !saveMessage.includes('âœ—') && !saveMessage.includes('Cannot')"
           [class.text-gray-800]="!saveMessage.includes('âœ“') && !saveMessage.includes('âœ—') && !saveMessage.includes('Cannot')">
        {{ saveMessage }}
      </div>
    </div>

    <div *ngIf="students.length === 0 || assignments.length === 0" class="empty-state text-center py-8">
      <p class="text-gray-600">
        <span *ngIf="students.length === 0">No students enrolled in this course.</span>
        <span *ngIf="students.length > 0 && assignments.length === 0">No assignments created yet.</span>
      </p>
    </div>

    <div *ngIf="students.length > 0 && assignments.length > 0" class="table-wrapper shadow-md rounded-lg"
         style="overflow-x: auto; overflow-y: visible;">
      <table class="min-w-full bg-white border-collapse">
        <thead class="bg-gray-100 sticky top-0">
        <tr>
          <th
            class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b-2 border-gray-300 sticky left-0 bg-gray-100 z-10">
            Student Name
          </th>
          <th *ngFor="let assignment of assignments"
              class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b-2 border-gray-300 min-w-[120px]">
            <div class="flex flex-col">
              <span class="font-semibold">{{ assignment.title }}</span>
              <span class="text-xs text-gray-500 font-normal mt-1">
                  Avg: {{ getAverageForAssignment(assignment.id) ?? 'â€”' }}%
                </span>
            </div>
          </th>
          <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b-2 border-gray-300 bg-blue-50">
            Average
          </th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let student of students; let i = index"
            [class.bg-gray-50]="i % 2 === 0"
            class="hover:bg-blue-50 transition-colors">
          <td class="px-4 py-3 text-sm font-medium text-gray-900 border-b border-gray-200 sticky left-0 z-10"
              [class.bg-gray-50]="i % 2 === 0"
              [class.bg-white]="i % 2 === 1">
            {{ student.name }}
          </td>
          <td *ngFor="let assignment of assignments"
              class="px-4 py-3 text-center border-b border-gray-200 relative">
            <div class="relative">
              <input
                type="number"
                min="0"
                max="100"
                [value]="getGradeCell(student.id, assignment.id)?.grade ?? ''"
                (input)="onGradeChange(student.id, assignment.id, $any($event.target).value)"
                class="w-full px-2 py-1 text-center border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                [class.border-gray-300]="!isInvalid(student.id, assignment.id) && !isChanged(student.id, assignment.id)"
                [class.border-red-500]="isInvalid(student.id, assignment.id)"
                [class.bg-red-50]="isInvalid(student.id, assignment.id)"
                [class.border-yellow-400]="isChanged(student.id, assignment.id) && !isInvalid(student.id, assignment.id)"
                [class.bg-yellow-50]="isChanged(student.id, assignment.id) && !isInvalid(student.id, assignment.id)"
                placeholder="â€”"
              />
              <div *ngIf="getValidationMessage(student.id, assignment.id)"
                   class="absolute left-0 right-0 top-full mt-1 text-xs text-red-600 bg-red-50 border border-red-200 rounded px-2 py-1 z-10 whitespace-nowrap">
                {{ getValidationMessage(student.id, assignment.id) }}
              </div>
            </div>
          </td>
          <td class="px-4 py-3 text-center border-b border-gray-200 font-semibold bg-blue-50">
              <span [class.text-green-700]="getAverageForStudent(student.id)! >= 90"
                    [class.text-blue-700]="getAverageForStudent(student.id)! >= 75 && getAverageForStudent(student.id)! < 90"
                    [class.text-yellow-700]="getAverageForStudent(student.id)! >= 60 && getAverageForStudent(student.id)! < 75"
                    [class.text-red-700]="getAverageForStudent(student.id)! < 60"
                    [class.text-gray-500]="getAverageForStudent(student.id) === null">
                {{ getAverageForStudent(student.id) ?? 'â€”' }}%
              </span>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
      <h3 class="text-sm font-semibold text-gray-700 mb-2">Grading Instructions:</h3>
      <ul class="text-sm text-gray-600 space-y-1">
        <li>â€¢ Enter grades from 0 to 100</li>
        <li>â€¢ Changed cells will be highlighted in <span
          class="bg-yellow-50 px-2 py-0.5 border border-yellow-400 rounded">yellow</span></li>
        <li>â€¢ Invalid grades will show in <span class="bg-red-50 px-2 py-0.5 border border-red-500 rounded">red</span>
          with error messages
        </li>
        <li>â€¢ Click the <span class="font-semibold">"ðŸ’¾ Save Changes"</span> button to save all modifications</li>
        <li>â€¢ Leave empty to remove a grade</li>
        <li>â€¢ Average colors: <span class="text-green-700 font-semibold">90-100</span>,
          <span class="text-blue-700 font-semibold">75-89</span>,
          <span class="text-yellow-700 font-semibold">60-74</span>,
          <span class="text-red-700 font-semibold">&lt;60</span>
        </li>
      </ul>
    </div>
  </div>
</div>
